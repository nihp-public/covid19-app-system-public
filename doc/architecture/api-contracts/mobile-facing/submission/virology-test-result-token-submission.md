# Virology Test Result Token Submission for Result Retrieval 

> API Pattern: [Submission](../../../api-patterns.md#submission)

## HTTP Request and Response

### V1 API (deprecated)
 
Retrieve the result for a cta token that was not generated by the mobile application:
- Return of the test result from in exchange for a cta token: ```POST https://<FQDN>/virology-test/cta-exchange```
- PCR-based and LFD-based test results (depending on the current policy) could be returned to old app versions (old app versions can not distinguish between PCR and LFD results)

### V2 API
 
Retrieve the result for a cta token that was not generated by the mobile application:
- Return of the test result from in exchange for a cta token: ```POST https://<FQDN>/virology-test/v2/cta-exchange```
- PCR-based and LFD-based test results will be returned

### Parameters

- Authorization required and signatures provided - see [API security](../../../api-security.md)
- Payload content-type: ```application/json```

## Scenarios

The Virology Testing API provides HTTP endpoints to retrieve URLs and tokens for the interaction with the virology testing website and to enable retrieving test results later.

Virology tokens follow the [Crockford and Damm](../../../../design/details/crockford-damm.md) algorithm.

Please note: testResult INDETERMINATE reported by Fiorano will be delivered as VOID to the mobile application - the behaviour could change in the future.

### V1 API: Obtain a test result in exchange for a cta token received in a test result notification

```POST https://<FQDN>/virology-test/cta-exchange``` (deprecated)

- Security: This endpoint will be made slow (response time) by design to avoid brute-force attacks.

#### Request Payload Example
```json
{
    "ctaToken": "1234abcd"
}
```

#### Response Payload Example
```json
{
    "diagnosisKeySubmissionToken": "6B162698-ADC5-47AF-8790-71ACF770FFAF",
    "testEndDate": "2020-04-23T00:00:00Z",
    "testResult": "POSITIVE"|"NEGATIVE"|"VOID"|"PLOD"
}
```

Notes: 
- See [diagnosis-key-submission.md](diagnosis-key-submission.md) for more info about the `diagnosisKeySubmissionToken` field.

### V2 API: Obtain a test result in exchange for a cta token received in a test result notification

```POST https://<FQDN>/virology-test/v2/cta-exchange```

- Security: This endpoint will be made slow (response time) by design to avoid brute-force attacks.

#### Request Payload Example
```json
{
    "ctaToken": "1234abcd",
    "country": "England"|"Wales"
}
```

#### Response Payload Example
```json
{
    "diagnosisKeySubmissionToken": "6B162698-ADC5-47AF-8790-71ACF770FFAF"|null,
    "testEndDate": "2020-04-23T00:00:00Z",
    "testResult": "POSITIVE"|"NEGATIVE"|"VOID"|"PLOD",
    "testKit": "LAB_RESULT"|"RAPID_RESULT"|"RAPID_SELF_REPORTED",
    "diagnosisKeySubmissionSupported": true|false,
    "requiresConfirmatoryTest": true|false,
    "confirmatoryDayLimit": null|-1|0|>=1,
    "shouldOfferFollowUpTest": true|false
}
```

- `diagnosisKeySubmissionToken` can be `null`, if `diagnosisKeySubmissionSupported` is `false`
- `requiresConfirmatoryTest` indicates whether the user should be taken through the confirmatory test journey or not.
- `confirmatoryDayLimit` the value can be:
    - `null`: it does not apply to the current journey
    - `-1`: no window
    - `0`: window is 0 days
    - `>=1`: non-zero day window
    - **Note**: `confirmatoryDayLimit` value must be `null` if `requiresConfirmatoryTest` is equal to `false`
- `shouldOfferFollowUpTest` indicates whether the user should be offered a follow-up test
  - **Note:**: `requiresConfirmatoryTest` value can not be `false` when `shouldOfferFollowUpTest` is equal to `true`
- See [diagnosis-key-submission.md](diagnosis-key-submission.md) for more info about the `diagnosisKeySubmissionToken` field.

### HTTP Response Codes
  - `200 OK` ok
  - `404 Not Found` cta token not found (also  for V1: ctaToken refers to a LFD test result - depending on the current policy)

#### Maintenance Mode

When the service is in [maintenance mode](../../../../design/details/api-maintenance-mode.md), all services will return `503 Service Unavailable`. Maintenance mode is used when performing operations like backup and restore of the service data.

### Notes

- See [Key User Journeys](../../../journeys.md) for conceptual system flows
